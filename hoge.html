<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最新の視程情報と時刻</title>
</head>
<body>
    <div class="container">
        <h1>最新の視程情報と時刻</h1>
        <div id="reports">
            <div class="metar-report" id="rjsn"></div>
            <div class="metar-report" id="rjnt"></div>
            <div class="metar-report" id="rjnk"></div>
            <div class="metar-report" id="visibility_54232"></div>
            <div class="metar-report" id="visibility_54157"></div>
            <div class="metar-report" id="visibility_54651"></div>
            <div class="metar-report" id="visibility_55102"></div>
            <div class="metar-report" id="visibility_55091"></div>
            <div class="metar-report" id="visibility_56052"></div>
            <div class="metar-report" id="visibility_56227"></div>
            <div class="metar-report" id="visibility_57066"></div>
            <div class="metar-report" id="visibility_57248"></div>         
        </div>
    </div>

    <script>
        async function fetchMetar(stationId) {
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://tgftp.nws.noaa.gov/data/observations/metar/stations/' + stationId + '.TXT')}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error fetching METAR data: ${response.statusText}`);
                }
                const data = await response.json();
                const text = data.contents;
                return text.split('\n').filter(line => line)[1]; // Get the second line which contains the METAR report
            } catch (error) {
                console.error('Error:', error);
                return 'METAR data could not be retrieved.';
            }
        }

        function extractVisibility(metar) {
            if (metar.includes('CAVOK')) {
                return '9999';
            }
            const visibilityRegex = /\b(\d{4})\b/; // Matches a group of 4 digits which is a common format for visibility
            const match = metar.match(visibilityRegex);
            return match ? match[1] : '視程情報が見つかりませんでした';
        }

        function extractTime(metar) {
            const timeRegex = /\b(\d{6}Z)\b/; // Matches the time format in METAR (e.g., 123456Z)
            const match = metar.match(timeRegex);
            return match ? match[1] : '時刻情報が見つかりませんでした';
        }

        function convertUTCTimeToISO8601(timeInUTC) {
  // timeInUTCは'132300Z'のような形式であると想定
  
  // 時刻部分を抽出
  const day = parseInt(timeInUTC.slice(0, 2), 10);
  const hour = parseInt(timeInUTC.slice(2, 4), 10);
            console.log(hour);
  const minute = parseInt(timeInUTC.slice(4, 6), 10);
  
  // ISO 8601形式の文字列を作成
  const isoTimeString = `${day.toString().padStart(2, '0')}日${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
  
  return isoTimeString;
}
        
        async function displayMetarReports() {
            const stations = ['RJSN', 'RJNT', 'RJNK'];
            const stationNames = {
                'RJSN': '新潟空港',
                'RJNT': '富山空港',
                'RJNK': '小松空港',
            };

            for (const station of stations) {
                const report = await fetchMetar(station);
                const visibility = extractVisibility(report);
                const time = extractTime(report);
                const isoTimeString = convertUTCTimeToISO8601(time);
                document.getElementById(station.toLowerCase()).textContent = `${stationNames[station]}: 視程 ${visibility} メートル, (${isoTimeString})`;
            }
        }

        async function displayVisibility() {
            try {
                const response = await fetch('https://api.allorigins.win/get?url=https://www.jma.go.jp/bosai/amedas/data/latest_time.txt');
                const latestTimeText = await response.json();
                const latestTime = latestTimeText.contents.trim().replace(/[-T:+]/g, '').substring(0, 12);
                const url = `https://www.jma.go.jp/bosai/amedas/data/map/${latestTime}00.json`;
                console.log(url)
                const dataResponse = await fetch(url);
                const data = await dataResponse.json();

                const points = [
                    { code: '54232', name: '新潟' },
                    { code: '54157', name: '相川' },
                    { code: '54651', name: '高田' },
                    { code: '55102', name: '富山' },
                    { code: '55091', name: '伏木' },
                    { code: '56052', name: '輪島' },
                    { code: '56227', name: '金沢' },
                    { code: '57066', name: '福井' },
                    { code: '57248', name: '敦賀' }
                ];

                points.forEach(point => {
                    const visibility = data[point.code]?.['visibility'][0] ?? 'データなし';
                    document.getElementById(`visibility_${point.code}`).innerText = `${point.name}:  視程 ${visibility} メートル (${latestTime})`;
                });
            } catch (error) {
                console.error(error);
            }
        }

        window.onload = displayVisibility;

        displayMetarReports();
    </script>
</body>
</html>
